#!/usr/bin/env bash

# Скрипт для полного "жесткого" отката конфигурации NixOS к определенному коммиту.
# ВНИМАНИЕ: Этот скрипт выполняет необратимые действия, включая `git push --force`.

# Прекращаем выполнение при любой ошибке
set -e

# --- Конфигурация ---
REPO_URL="git@github.com:skardiz/nixos-config.git"
CONFIG_DIR_NAME="nixos-config"
CONFIG_PATH="$HOME/$CONFIG_DIR_NAME"
# Создаем бэкап с датой и временем
BACKUP_PATH="$HOME/${CONFIG_DIR_NAME}.$(date +%Y%m%d_%H%M%S).BAK"

# --- Цвета для вывода ---
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# --- Вспомогательные функции ---
info() {
    echo -e "${GREEN}INFO:${NC} $1"
}

warning() {
    echo -e "${YELLOW}WARNING:${NC} $1"
}

error_exit() {
    echo -e "${RED}ERROR:${NC} $1" >&2
    exit 1
}

# --- Начало скрипта ---
clear
echo "=========================================================="
echo " NixOS Configuration Rollback and Rebuild Script"
echo "=========================================================="
echo

info "Этот скрипт выполнит ПОЛНЫЙ И ЖЕСТКИЙ откат вашей конфигурации."

# 1. Запрос хэша коммита
read -p "Пожалуйста, введите ПОЛНЫЙ хэш коммита для отката: " COMMIT_HASH

if [[ -z "$COMMIT_HASH" ]]; then
    error_exit "Хэш коммита не может быть пустым. Операция прервана."
fi

# 2. Финальное предупреждение и подтверждение
echo
echo -e "${RED}!!! ВНИМАНИЕ: ОПАСНАЯ ОПЕРАЦИЯ !!!${NC}"
warning "Вы собираетесь выполнить следующие НЕОБРАТИМЫЕ действия:"
echo "- Текущая папка '$CONFIG_PATH' будет перемещена в '$BACKUP_PATH'."
echo "- Будет склонирована чистая копия репозитория с GitHub."
echo "- Локальный репозиторий будет откачен к коммиту: ${YELLOW}$COMMIT_HASH${NC}."
echo "- Это изменение будет ${RED}ПРИНУДИТЕЛЬНО ОТПРАВЛЕНО (FORCE PUSH)${NC} на GitHub, перезаписав публичную историю."
echo "- Системный кеш Nix будет очищен, и система будет пересобрана с нуля."
echo

read -p "Вы абсолютно уверены, что хотите продолжить? (y/n) " -n 1 -r
echo
if [[ ! $REPLY =~ ^[YyДд]$ ]]; then
    error_exit "Операция отменена пользователем."
fi

# --- Выполнение действий ---
info "Начинаю операцию отката..."

# Шаг 1: Бэкап и клонирование
info "[1/4] Создание бэкапа и клонирование репозитория..."
cd "$HOME"
if [ -d "$CONFIG_PATH" ]; then
    info "Найдена существующая папка конфигурации. Перемещаю в бэкап..."
    mv "$CONFIG_PATH" "$BACKUP_PATH"
    info "Бэкап создан: $BACKUP_PATH"
fi
git clone "$REPO_URL" "$CONFIG_DIR_NAME"
cd "$CONFIG_PATH"
info "Репозиторий успешно склонирован."

# Шаг 2: Откат Git и принудительная отправка
info "[2/4] Откат к коммиту $COMMIT_HASH и принудительная отправка на GitHub..."
git reset --hard "$COMMIT_HASH"
info "Локальный репозиторий успешно откачен."
git push origin main --force
info "История на GitHub успешно перезаписана."

# Шаг 3: Очистка Nix
info "[3/4] Удаление flake.lock и очистка системного кеша Nix..."
rm -f flake.lock
info "flake.lock удален."
sudo nix-collect-garbage -d
info "Кеш Nix очищен."

# Шаг 4: Финальная пересборка
info "[4/4] Запуск финальной пересборки системы. Это займет много времени."
warning "Пожалуйста, НЕ ПРЕРЫВАЙТЕ этот процесс."
sudo nixos-rebuild switch --flake .#shershulya

echo
echo "=========================================================="
info "ОТКАТ И ПЕРЕСБОРКА СИСТЕМЫ УСПЕШНО ЗАВЕРШЕНЫ!"
info "Ваша система теперь работает на конфигурации из коммита ${YELLOW}$COMMIT_HASH${NC}."
echo "=========================================================="

exit 0
