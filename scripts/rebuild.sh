#!/usr/bin/env bash
# Завершить скрипт, если любая команда завершится с ошибкой
set -e

# Указываем путь к конфигурации для надежности
CONFIG_DIR="/home/alex/nixos-config"
# Переходим в директорию с конфигурацией. Выходим, если не получилось.
cd "$CONFIG_DIR" || exit

# --- Шаг 1: Обновление зависимостей ---
echo -e "\n\e[32m>>> Шаг 1: Обновление зависимостей (flake update)...\e[0m"
nix flake update

# --- Проверка на наличие изменений ---
# Если нет изменений, просто пересобираем систему и выходим.
if [ -z "$(git status --porcelain)" ]; then
  echo -e "\n\e[33m>>> Нет изменений для коммита. Запускаем только сборку системы...\e[0m"
  sudo nixos-rebuild switch --flake .#shershulya
  echo -e "\n\e[1;32m✅ Система успешно пересобрана (без новых коммитов)!\e[0m"
  exit 0
fi

# Если изменения есть, требуем сообщение для коммита.
if [ -z "$1" ]; then
  echo "Ошибка: есть изменения, но не указано сообщение для коммита."
  echo "Пример: rebuild \"feat: добавил новый пакет\""
  exit 1
fi

# --- Шаг 2: Тестовая сборка во временной директории ---
echo -e "\n\e[32m>>> Шаг 2: Тестовая сборка системы (в /tmp)...\e[0m"

# Создаем временную директорию в /tmp
TMP_DIR=$(mktemp -d)
# Гарантируем, что временная директория будет удалена при выходе из скрипта (даже при ошибке)
trap 'rm -rf "$TMP_DIR"' EXIT

# Запускаем сборку ИЗ временной директории, указывая путь к нашему flake.
# Это заставит Nix создать `result` внутри /tmp, а не в нашей папке.
(cd "$TMP_DIR" && sudo nixos-rebuild build --flake "$CONFIG_DIR#shershulya")

echo -e "\e[32m>>> Сборка прошла успешно! Ваша папка с конфигами осталась чистой.\e[0m"

# --- Шаг 3: Добавление всех изменений в Git ---
echo -e "\n\e[32m>>> Шаг 3: Добавление всех изменений в Git...\e[0m"
git add .

# --- Шаг 4: Создание коммита ---
echo -e "\n\e[32m>>> Шаг 4: Создание коммита...\e[0m"
git commit -m "$1"

# --- Шаг 5: Отправка изменений на GitHub ---
echo -e "\n\e[32m>>> Шаг 5: Отправка изменений на GitHub...\e[0m"
git push

# --- Шаг 6: Активация уже собранной конфигурации ---
echo -e "\n\e[32m>>> Шаг 6: Активация новой конфигурации...\e[0m"
sudo nixos-rebuild switch --flake .#shershulya

echo -e "\n\e[1;32m✅ Система успешно обновлена, и изменения отправлены на GitHub!\e[0m"
