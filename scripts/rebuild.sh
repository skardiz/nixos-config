#!/usr/bin/env bash
# Завершить скрипт, если любая команда завершится с ошибкой
set -e

# Переходим в директорию с конфигурацией
cd /home/alex/nixos-config

# Шаг 1: Обновление зависимостей
echo -e "\n\e[32m>>> Шаг 1: Обновление зависимостей (flake update)...\e[0m"
nix flake update

# --- НОВАЯ, УЛУЧШЕННАЯ ПРОВЕРКА ИЗМЕНЕНИЙ ---
# Проверяем, есть ли ВООБЩЕ какие-либо изменения (включая новые неотслеживаемые файлы)
if [ -z "$(git status --porcelain)" ]; then
  # Если вывод `git status --porcelain` пустой, значит, изменений нет
  echo -e "\n\e[33m>>> Нет изменений для коммита. Запускаем только сборку системы...\e[0m"
  sudo nixos-rebuild switch --flake .#shershulya
  echo -e "\n\e[1;32m✅ Система успешно пересобрана (без новых коммитов)!\e[0m"
  exit 0
fi

# Если изменения есть, продолжаем стандартный процесс
if [ -z "$1" ]; then
  echo "Ошибка: есть изменения, но не указано сообщение для коммита."
  echo "Пример: rebuild \"feat: добавил новый пакет\""
  exit 1
fi

echo -e "\n\e[32m>>> Шаг 2: Добавление всех изменений в Git (включая новые файлы)...\e[0m"
git add .

echo -e "\n\e[32m>>> Шаг 3: Создание коммита...\e[0m"
git commit -m "$1"

echo -e "\n\e[32m>>> Шаг 4: Запуск сборки системы NixOS...\e[0m"
sudo nixos-rebuild switch --flake .#shershulya

echo -e "\n\e[32m>>> Шаг 5: Отправка изменений на GitHub...\e[0m"
git push

echo -e "\n\e[1;32m✅ Система успешно обновлена и изменения отправлены на GitHub!\e[0m"
