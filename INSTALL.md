# Инструкция по установке моей конфигурации NixOS

Этот документ описывает, как развернуть эту конфигурацию NixOS на новой машине, начиная с момента после разметки и форматирования дисков.

## Предварительные условия

*   Вы загрузились с установочного носителя NixOS.
*   У вас есть стабильное подключение к интернету.
*   Диски размечены и отформатированы. Корневой раздел примонтирован в `/mnt`, а EFI-раздел (если используется) — в `/mnt/boot`.

---

## Этап 1: Базовая установка NixOS (из Live USB)

Цель этого этапа — установить минимальную систему с Git и вашим пользователем, чтобы мы могли развернуть полную конфигурацию на следующем шаге.

### 1. Генерация базовых файлов конфигурации

Выполните эту команду, чтобы NixOS сгенерировала `configuration.nix` и `hardware-configuration.nix` на основе вашего оборудования.

`nixos-generate-config --root /mnt`

### 2. Редактирование временной `configuration.nix`

Нам нужно создать временную конфигурацию для первой установки. Откройте файл `/mnt/etc/nixos/configuration.nix` в текстовом редакторе (например, `nano`):

`nano /mnt/etc/nixos/configuration.nix`

Приведите его к следующему виду. **Это временная конфигурация, только для первой загрузки!**
```
/mnt/etc/nixos/configuration.nix

{ config, pkgs, ... }:

{
imports = [
# Обязательно импортируем файл сгенерированного оборудования
./hardware-configuration.nix
];
Включаем Flakes и Nix-команды

nix.settings.experimental-features = [ "nix-command" "flakes" ];
Настройка загрузчика

boot.loader.systemd-boot.enable = true;
boot.loader.efi.canTouchEfiVariables = true;
Настройка сети

networking.networkmanager.enable = true;
Временная зона

time.timeZone = "Europe/Moscow";
Локализация

i18n.defaultLocale = "ru_RU.UTF-8";
console.keyMap = "ru";
Создаем вашего пользователя и даем ему права sudo

users.users.alex = {
isNormalUser = true;
extraGroups = [ "wheel" ]; # Позволяет использовать sudo
};
Устанавливаем Git, он понадобится на следующем этапе

environment.systemPackages = with pkgs; [
git
];
ВАЖНО: Разрешаем несвободные пакеты для будущей установки драйверов NVIDIA

nixpkgs.config.allowUnfree = true;

system.stateVersion = "25.11"; # Или ваша версия
}
```

### 3. Установка системы и установка паролей

Теперь запустите установку NixOS.

`nixos-install`

После завершения установки, **не перезагружаясь**, установите пароль для вашего пользователя `alex` и для `root`.

Входим в свежеустановленную систему

`nixos-enter`
Устанавливаем пароль для пользователя alex

`passwd alex`
Устанавливаем пароль для root (на всякий случай)

`passwd`
Выходим из chroot

`exit`

### 4. Перезагрузка

Теперь можно перезагружаться в новую систему.

`reboot`

---

## Этап 2: Развертывание полной конфигурации

После перезагрузки войдите в систему под пользователем `alex`. Теперь мы заменим временную конфигурацию на нашу, из репозитория.

### 1. Клонирование репозитория

Откройте терминал и клонируйте ваш репозиторий с конфигурацией в домашнюю директорию.

`git clone https://github.com/skardiz/nixos-config.git ~/nixos-config`

### 2. Копирование `hardware-configuration.nix`

Нам нужно использовать `hardware-configuration.nix`, сгенерированный на первом этапе, так как он соответствует вашему текущему оборудованию.

`sudo cp /etc/nixos/hardware-configuration.nix ~/nixos-config/`

Введите ваш пароль, когда потребуется.

### 3. Первая сборка полной конфигурации

Теперь, когда у вас есть полная конфигурация, примените ее. Так как наш скрипт `rebuild` еще не установлен, мы используем стандартную команду.

`sudo nixos-rebuild switch --flake ~/nixos-config#shershulya`

Этот процесс может занять время, так как система будет скачивать и устанавливать все пакеты: KDE Plasma, ядро Zen, драйверы NVIDIA и т.д.

### 4. Настройка прав доступа (опционально, но рекомендуется)

Чтобы в будущем управлять конфигурацией без `sudo` для операций с Git, настройте права на директорию. Это уже должно быть настроено в вашем `users.nix`, но убедитесь, что это так.

Эта команда больше не нужна, так как мы работаем из ~/nixos-config
`sudo chown -R root:nixos-config /etc/nixos`
`sudo chmod -R g+w /etc/nixos`

## Готово!

После успешного завершения `nixos-rebuild switch`, ваша система полностью настроена в соответствии с этим репозиторием. Все будущие изменения вы можете делать, редактируя файлы в `~/nixos-config` и используя вашу команду:

`rebuild "описание изменений"`
