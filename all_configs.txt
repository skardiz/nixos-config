
# ==============================================================================
# –§–ê–ô–õ: ./README.md
# ==============================================================================

# NixOS Citadel: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è shershulya

> "–•–æ—Ä–æ—à–∏–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä –Ω–µ —É–∫—Ä–∞—à–∞–µ—Ç –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏, –∞ –∫–æ–Ω—Å—Ç—Ä—É–∏—Ä—É–µ—Ç —É–∫—Ä–∞—à–µ–Ω–∏—è."
> ‚Äî –ê–≤–≥—É—Å—Ç –ü—å—é–¥–∂–∏–Ω

–≠—Ç–æ—Ç —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π ‚Äî –Ω–µ –ø—Ä–æ—Å—Ç–æ –Ω–∞–±–æ—Ä "–¥–æ—Ç—Ñ–∞–π–ª–æ–≤". –≠—Ç–æ –º–æ—è –ª–∏—á–Ω–∞—è, –∂–∏–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–∏–ª–æ—Å–æ—Ñ–∏–∏ NixOS: —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é –¥–µ–∫–ª–∞—Ä–∞—Ç–∏–≤–Ω–æ–π, –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º–æ–π –∏ –∏–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫–∏ –≤—ã–≤–µ—Ä–µ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã –¥–ª—è –ø–æ–≤—Å–µ–¥–Ω–µ–≤–Ω–æ–π –∂–∏–∑–Ω–∏, —Ä–∞–±–æ—Ç—ã –∏ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ–≤.

## ‚ú® –§–∏–ª–æ—Å–æ—Ñ–∏—è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

–≠—Ç–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∞ –Ω–µ –Ω–∞ —Ñ–∞–π–ª–∞—Ö, –∞ –Ω–∞ **–∏–¥–µ—è—Ö**:

1.  **–ú–æ–¥—É–ª—å–Ω–æ—Å—Ç—å –∫–∞–∫ –≤ LEGO:** –ö–∞–∂–¥—ã–π –∞—Å–ø–µ–∫—Ç —Å–∏—Å—Ç–µ–º—ã ‚Äî —ç—Ç–æ –æ—Ç–¥–µ–ª—å–Ω—ã–π, —Å–∞–º–æ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–π "–∫–∏—Ä–ø–∏—á–∏–∫" (`modules/features`). –ú—ã –Ω–µ —Å—Ç—Ä–æ–∏–º –º–æ–Ω–æ–ª–∏—Ç, –º—ã —Å–æ–±–∏—Ä–∞–µ–º –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä.

2.  **–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π –ü—É–ª—å—Ç –£–ø—Ä–∞–≤–ª–µ–Ω–∏—è:** –í–º–µ—Å—Ç–æ —Ç–æ–≥–æ —á—Ç–æ–±—ã —Ä–∞–∑–±—Ä–∞—Å—ã–≤–∞—Ç—å –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–∏ –ø–æ –≤—Å–µ–π —Å–∏—Å—Ç–µ–º–µ, –º—ã —Å–æ–∑–¥–∞–ª–∏ –µ–¥–∏–Ω—ã–π "–ø—É–ª—å—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è" (`modules/core/options.nix`). –•–æ—á–µ—à—å –≤–∫–ª—é—á–∏—Ç—å –∏–≥—Ä—ã –∏–ª–∏ Android? –ü—Ä–æ—Å—Ç–æ –Ω–∞–∂–º–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ.

3.  **–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –í–ª–∞—Å—Ç–µ–π:**
    *   **–°–∏—Å—Ç–µ–º–∞ (`NixOS`)** –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç, —Å—Ç–µ–Ω—ã –∏ –≥–æ—Ä–æ–¥—Å–∫–∏–µ —Å–ª—É–∂–±—ã.
    *   **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (`Home Manager`)** –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –º–µ–±–µ–ª—å, –æ–±–æ–∏ –∏ –ª–∏—á–Ω—ã–µ –≤–µ—â–∏ –≤ —Å–≤–æ–µ–π –∫–≤–∞—Ä—Ç–∏—Ä–µ. –≠—Ç–∏ –¥–≤–∞ –º–∏—Ä–∞ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –ø–µ—Ä–µ—Å–µ–∫–∞—é—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é.

4.  **–ù–∏—á–µ–≥–æ –ª–∏—à–Ω–µ–≥–æ:** –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–æ—à–ª–∞ —á–µ—Ä–µ–∑ —ç—Ç–∞–ø —Ä–∞–¥–∏–∫–∞–ª—å–Ω–æ–≥–æ —É–ø—Ä–æ—â–µ–Ω–∏—è. –ú—ã –∏–∑–±–∞–≤–∏–ª–∏—Å—å –æ—Ç –≤—Å–µ—Ö —Å–ª–æ–∂–Ω—ã—Ö –æ–≤–µ—Ä–ª–µ–µ–≤ –∏ –∫–∞—Å—Ç–æ–º–Ω—ã—Ö —Å–±–æ—Ä–æ–∫ –≤ –ø–æ–ª—å–∑—É —á–∏—Å—Ç–æ—Ç—ã –∏ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏.

## üó∫Ô∏è –ö–∞—Ä—Ç–∞ –¶–∏—Ç–∞–¥–µ–ª–∏: –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ü—Ä–æ–µ–∫—Ç–∞

–≠—Ç–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ ‚Äî —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–æ–ª–≥–æ–≥–æ –ø—É—Ç–∏. –û–Ω–∞ ‚Äî —Å–µ—Ä–¥—Ü–µ –≤—Å–µ–π —Å–∏—Å—Ç–µ–º—ã.
```
.
‚îú‚îÄ‚îÄ flake.nix # <<< –ì–ª–∞–≤–Ω—ã–µ –í–æ—Ä–æ—Ç–∞ –∏ –¢–∞–º–æ–∂–Ω—è >>>
‚îÇ # –ó–¥–µ—Å—å –º—ã –æ–±—ä—è–≤–ª—è–µ–º –≤—Å–µ –Ω–∞—à–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Ç–æ—á–∫–∏ –≤—Ö–æ–¥–∞.
‚îÇ
‚îú‚îÄ‚îÄ hosts/ # <<< –ö–æ–º–∞–Ω–¥–Ω—ã–π –¶–µ–Ω—Ç—Ä >>>
‚îÇ ‚îú‚îÄ‚îÄ shershulya/ # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –º–∞—à–∏–Ω—ã "shershulya".
‚îÇ ‚îÇ ‚îî‚îÄ‚îÄ default.nix # -- –ì–ï–ù–ï–†–ê–õ–¨–ù–´–ô –ü–õ–ê–ù -- –ì–æ–≤–æ—Ä–∏—Ç, –∫–∞–∫–∏–µ "—Ä–æ–ª–∏" –∏
‚îÇ ‚îÇ # "–æ–ø—Ü–∏–∏" –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è —ç—Ç–æ–≥–æ –≥–æ—Ä–æ–¥–∞.
‚îÇ ‚îî‚îÄ‚îÄ _common/ # -- –ö–û–ù–°–¢–ò–¢–£–¶–ò–Ø -- –û–±—â–∏–µ –∑–∞–∫–æ–Ω—ã –¥–ª—è –≤—Å–µ—Ö –≥–æ—Ä–æ–¥–æ–≤.
‚îÇ
‚îú‚îÄ‚îÄ modules/ # <<< –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–µ –ë—é—Ä–æ >>> –ù–∞—à–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ —á–µ—Ä—Ç–µ–∂–µ–π.
‚îÇ ‚îú‚îÄ‚îÄ core/ # -- –Ø–î–†–û -- –§—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ –º–æ–¥—É–ª–∏.
‚îÇ ‚îÇ ‚îú‚îÄ‚îÄ options.nix # -- –ü–£–õ–¨–¢ –£–ü–†–ê–í–õ–ï–ù–ò–Ø -- –ù–∞—à —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π API –¥–ª—è —Å–∏—Å—Ç–µ–º—ã.
‚îÇ ‚îÇ ‚îî‚îÄ‚îÄ users.nix # -- –ü–ê–°–ü–û–†–¢–ù–´–ô –°–¢–û–õ -- –£–ø—Ä–∞–≤–ª—è–µ—Ç –≤—Å–µ–º–∏ –∂–∏—Ç–µ–ª—è–º–∏.
‚îÇ ‚îú‚îÄ‚îÄ features/ # -- –°–ö–õ–ê–î –§–ò–ß -- –Ø—â–∏–∫–∏ —Å "—Ç—è–∂–µ–ª—ã–º–∏" –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è–º–∏.
‚îÇ ‚îú‚îÄ‚îÄ hardware/ # –ú–æ–¥—É–ª–∏ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∂–µ–ª–µ–∑–∞.
‚îÇ ‚îî‚îÄ‚îÄ roles/ # -- –¢–ò–ü–û–í–´–ï –ü–†–û–ï–ö–¢–´ -- –ì–æ—Ç–æ–≤—ã–µ "–Ω–∞–±–æ—Ä—ã LEGO" –∏–∑ —Ñ–∏—á.
‚îÇ
‚îî‚îÄ‚îÄ home/ # <<< –ñ–∏–ª–æ–π –ö–æ–º–ø–ª–µ–∫—Å >>> –õ–∏—á–Ω—ã–µ –≤–µ—â–∏ –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
‚îú‚îÄ‚îÄ alex/ # –ö–≤–∞—Ä—Ç–∏—Ä–∞ –ê–ª–µ–∫—Å–∞.
‚îú‚îÄ‚îÄ mari/ # –ö–≤–∞—Ä—Ç–∏—Ä–∞ –ú–∞—Ä–∏.
‚îî‚îÄ‚îÄ _common/ # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –º–µ–±–µ–ª—å –∏ —Å–∞–Ω—Ç–µ—Ö–Ω–∏–∫–∞ –¥–ª—è –≤—Å–µ—Ö –∫–≤–∞—Ä—Ç–∏—Ä.
```
## üíé –ñ–µ–º—á—É–∂–∏–Ω—ã –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

–í —ç—Ç–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –µ—Å—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–µ—à–µ–Ω–∏–π, –∫–æ—Ç–æ—Ä—ã–º–∏ —è –æ—Å–æ–±–µ–Ω–Ω–æ –≥–æ—Ä–∂—É—Å—å:

*   **–°–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π –º–∏–Ω–∏-—Ñ—Ä–µ–π–º–≤–æ—Ä–∫:** –§–∞–π–ª—ã –≤ `modules/core/` —Å–æ–∑–¥–∞—é—Ç –Ω–∞—à—É —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—É—é, –≤—ã—Å–æ–∫–æ—É—Ä–æ–≤–Ω–µ–≤—É—é —Å–∏—Å—Ç–µ–º—É –æ–ø—Ü–∏–π (`my.*`). –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å –≤—Å–µ–π —Å–∏—Å—Ç–µ–º–æ–π —á–µ—Ä–µ–∑ –ø—Ä–æ—Å—Ç–æ–π –∏ –ø–æ–Ω—è—Ç–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å, –Ω–µ –∫–æ–ø–∞—è—Å—å –≤ –Ω–∏–∑–∫–æ—É—Ä–æ–≤–Ω–µ–≤—ã—Ö –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö.

*   **"–£–º–Ω—ã–π" WayDroid:** –ú–æ–¥—É–ª—å `features/android.nix` –Ω–µ –ø—Ä–æ—Å—Ç–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç WayDroid, –∞ –¥–µ–ª–∞–µ—Ç —ç—Ç–æ –≤–º–µ—Å—Ç–µ —Å `waydroid-idle.nix` ‚Äî –Ω–∞—à–∏–º —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–º —Å–µ—Ä–≤–∏—Å–æ–º, –∫–æ—Ç–æ—Ä—ã–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–∫–ª—é—á–∞–µ—Ç –ø—Ä–æ–∂–æ—Ä–ª–∏–≤—ã–π WayDroid –ø–æ—Å–ª–µ 5 –º–∏–Ω—É—Ç –±–µ–∑–¥–µ–π—Å—Ç–≤–∏—è.

*   **–†–æ–ª–µ–≤–∞—è –º–æ–¥–µ–ª—å:** –í–º–µ—Å—Ç–æ —Ç–æ–≥–æ —á—Ç–æ–±—ã –∑–∞–≥—Ä–æ–º–æ–∂–¥–∞—Ç—å `hosts/shershulya/default.nix` –¥–µ—Å—è—Ç–∫–∞–º–∏ –∏–º–ø–æ—Ä—Ç–æ–≤, –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º "—Ä–æ–ª–∏" (`roles/desktop.nix`). –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ–¥–Ω–∏–º –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–µ–º –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≤–µ—Å—å –Ω–∞–±–æ—Ä —Ñ—É–Ω–∫—Ü–∏–π –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –º–∞—à–∏–Ω—ã.

## üöÄ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∏ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

### –ü–µ—Ä–≤–∏—á–Ω–∞—è –£—Å—Ç–∞–Ω–æ–≤–∫–∞
1.  –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ NixOS —Å –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ –æ–±—Ä–∞–∑–∞, –Ω–µ —Å–æ–∑–¥–∞–≤–∞—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.
2.  –°–∫–ª–æ–Ω–∏—Ä—É–π—Ç–µ —ç—Ç–æ—Ç —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π:
    `git clone https://github.com/skardiz/nixos-config.git ~/nixos-config`
3.  **–ù–∞—Å—Ç—Ä–æ–π—Ç–µ —Å–µ–∫—Ä–µ—Ç—ã (–ª–æ–∫–∞–ª—å–Ω–æ):** –î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ API GitHub –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å —Ç–æ–∫–µ–Ω –¥–æ—Å—Ç—É–ø–∞. **–≠—Ç–æ—Ç —à–∞–≥ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ –∏ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –ø–æ–ø–∞–¥–∞–µ—Ç –≤ Git.**
    ```
    mkdir -p ~/.config/nix
    echo "access-tokens = github.com=–í–ê–®_–¢–û–ö–ï–ù_GITHUB" >> ~/.config/nix/nix.conf
    ```
4.  –°–æ–±–µ—Ä–∏—Ç–µ —Å–∏—Å—Ç–µ–º—É:
    `sudo nixos-rebuild switch --flake .#shershulya`

### –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π
`sudo nixos-rebuild switch --flake .#shershulya`

### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
`nix flake update`

## üèóÔ∏è –ß–µ—Ä—Ç–µ–∂–∏ –ë—É–¥—É—â–∏—Ö –ù–µ–±–æ—Å–∫—Ä–µ–±–æ–≤

–≠—Ç–æ—Ç –≥–æ—Ä–æ–¥ ‚Äî –∂–∏–≤–æ–π –æ—Ä–≥–∞–Ω–∏–∑–º. –í –ø–ª–∞–Ω–∞—Ö:

-   [ ] **–ü–æ—Å—Ç—Ä–æ–∏—Ç—å –°–µ–π—Ñ:** –í–Ω–µ–¥—Ä–∏—Ç—å `sops-nix` –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ, –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—Å–µ—Ö —Å–µ–∫—Ä–µ—Ç–æ–≤ (–ø–∞—Ä–æ–ª–µ–π, —Ç–æ–∫–µ–Ω–æ–≤, –∫–ª—é—á–µ–π) –ø—Ä—è–º–æ –≤ Git.
-   [ ] **–û—Å–Ω–æ–≤–∞—Ç—å –ö–æ–ª–æ–Ω–∏—é:** –î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –≤—Ç–æ—Ä–æ–π —Ö–æ—Å—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–æ—É—Ç–±—É–∫), —á—Ç–æ–±—ã –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∏ –æ—Ç—Ç–æ—á–∏—Ç—å –Ω–∞—à—É –º–æ–¥—É–ª—å–Ω—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É.
-   [ ] **–ó–∞–Ω—è—Ç—å—Å—è –î–∏–∑–∞–π–Ω–æ–º –ò–Ω—Ç–µ—Ä—å–µ—Ä–æ–≤:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `plasma-manager` –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ, –¥–µ–∫–ª–∞—Ä–∞—Ç–∏–≤–Ω–æ–≥–æ –æ–ø–∏—Å–∞–Ω–∏—è –≤–Ω–µ—à–Ω–µ–≥–æ –≤–∏–¥–∞ KDE Plasma, –æ—Ç –æ–±–æ–µ–≤ –¥–æ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏—è –≤–∏–¥–∂–µ—Ç–æ–≤.


# ==============================================================================
# –§–ê–ô–õ: ./home/alex/packages.nix
# ==============================================================================

# hm-modules/alex/packages.nix
{ pkgs, ... }:

{
  home.packages = with pkgs; [
    bash
    sops
    gnupg
    pinentry-curses
    #thorium-browser
  ];
}

# ==============================================================================
# –§–ê–ô–õ: ./home/alex/default.nix
# ==============================================================================

# home/alex/default.nix
{ pkgs, config, ... }:
{
  imports = [
    ../_common # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –í–°–ï –æ–±—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    ./packages.nix
  ];

  # --- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ó–î–ï–°–¨! ---
  # –ê–ª–µ–∫—Å –≤–∫–ª—é—á–∞–µ—Ç —Å–µ–±–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –Ω–∞–±–æ—Ä –ø–∞–∫–µ—Ç–æ–≤ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
  my.home.packages = {
    dev = true;
  };
}

# ==============================================================================
# –§–ê–ô–õ: ./home/mari/default.nix
# ==============================================================================

# home/mari/default.nix
{ pkgs, config, ... }:
{
  imports = [
    ../_common # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –í–°–ï –æ–±—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
  ];
}

# ==============================================================================
# –§–ê–ô–õ: ./home/_common/git.nix
# ==============================================================================

# home/_common/git.nix
# –≠—Ç–æ—Ç –º–æ–¥—É–ª—å —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ö–µ–ª–ø–µ—Ä –∏–∑ –Ω–∞—à–µ–π –∫–∞—Å—Ç–æ–º–Ω–æ–π –±–∏–±–ª–∏–æ—Ç–µ–∫–∏.
{ config, pkgs, mylib, ... }: # <-- –î–æ–±–∞–≤–ª—è–µ–º 'mylib' –≤ –∞—Ä–≥—É–º–µ–Ω—Ç—ã

let
  # –í—ã–∑—ã–≤–∞–µ–º –Ω–∞—à –Ω–æ–≤—ã–π, —á–∏—Å—Ç—ã–π —Ö–µ–ª–ø–µ—Ä –∏–∑ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏.
  # –ü–µ—Ä–µ–¥–∞–µ–º –µ–º—É –∏–º—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
  gitSettings = mylib.myHelpers.getGitConfigForUser config.home.username;
in
{
  programs.git = {
    enable = true;
    # –ü—Ä–∏–º–µ–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞–±–æ—Ç—ã —Ö–µ–ª–ø–µ—Ä–∞
    userName = gitSettings.userName;
    userEmail = gitSettings.userEmail;
  };
  services.ssh-agent.enable = true;
}

# ==============================================================================
# –§–ê–ô–õ: ./home/_common/waydroid-idle.nix
# ==============================================================================

# home/_common/waydroid-idle.nix
# –≠—Ç–æ—Ç –º–æ–¥—É–ª—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ö–µ–ª–ø–µ—Ä –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–ª–æ–∂–Ω–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞.
{ pkgs, mylib, ... }: # <-- –î–æ–±–∞–≤–ª—è–µ–º 'mylib' –≤ –∞—Ä–≥—É–º–µ–Ω—Ç—ã

let
  # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–∫—Ä–∏–ø—Ç-—Å—Ç–æ—Ä–æ–∂, –≤—ã–∑—ã–≤–∞—è –Ω–∞—à –Ω–æ–≤—ã–π —Ö–µ–ª–ø–µ—Ä.
  # –ü–µ—Ä–µ–¥–∞–µ–º –µ–º—É 'pkgs', —Ç–∞–∫ –∫–∞–∫ –æ–Ω–∏ –Ω—É–∂–Ω—ã –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–∫—Ä–∏–ø—Ç–∞.
  waydroid-idle-script = mylib.myHelpers.makeWaydroidIdleScript { inherit pkgs; };
in
{
  # –î–µ–∫–ª–∞—Ä–∞—Ç–∏–≤–Ω–æ —Å–æ–∑–¥–∞–µ–º –∏ –≤–∫–ª—é—á–∞–µ–º –Ω–∞—à –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —Å–µ—Ä–≤–∏—Å-—Å—Ç–æ—Ä–æ–∂.
  # –≠—Ç–æ—Ç –±–ª–æ–∫ –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π, –Ω–æ —Ç–µ–ø–µ—Ä—å –æ–Ω –∏—Å–ø–æ–ª—å–∑—É–µ—Ç
  # —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞–±–æ—Ç—ã –Ω–∞—à–µ–≥–æ —á–∏—Å—Ç–æ–≥–æ —Ö–µ–ª–ø–µ—Ä–∞.
  systemd.user.services.waydroid-idle-manager = {
    Unit = {
      Description = "WayDroid Idle Manager";
      After = [ "graphical-session.target" ];
    };
    Service = {
      ExecStart = "${waydroid-idle-script}/bin/waydroid-idle-manager";
      Restart = "always";
      RestartSec = 10;
    };
    Install = {
      WantedBy = [ "graphical-session.target" ];
    };
  };
}

# ==============================================================================
# –§–ê–ô–õ: ./home/_common/options.nix
# ==============================================================================

# home/_common/options.nix
# "–ü—É–ª—å—Ç –£–ø—Ä–∞–≤–ª–µ–Ω–∏—è" –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π.
{ lib, config, pkgs, ... }:
{
  options.my.home.packages = {
    common = lib.mkEnableOption "–ë–∞–∑–æ–≤—ã–π –Ω–∞–±–æ—Ä –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π (–±—Ä–∞—É–∑–µ—Ä, –æ—Ñ–∏—Å –∏ —Ç.–¥.)";
    dev = lib.mkEnableOption "–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏";
    # –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å –¥—Ä—É–≥–∏–µ –≥—Ä—É–ø–ø—ã: 'gaming', 'design' –∏ —Ç.–¥.
  };

  config = {
    # –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –ø–∞–∫–µ—Ç—ã –∏–∑ –≤–∫–ª—é—á–µ–Ω–Ω—ã—Ö –æ–ø—Ü–∏–π –≤ –æ–¥–∏–Ω —Å–ø–∏—Å–æ–∫
    home.packages = lib.mkMerge [
      (lib.mkIf config.my.home.packages.common [
        pkgs.google-chrome
        pkgs.libreoffice
        pkgs.obsidian
        pkgs.telegram-desktop
        pkgs.tree
        pkgs.zapzap
        pkgs.zoom-us
      ])
      (lib.mkIf config.my.home.packages.dev [
        pkgs.vscode
        pkgs.git-lfs
      ])
    ];
  };
}

# ==============================================================================
# –§–ê–ô–õ: ./home/_common/default.nix
# ==============================================================================

# home/_common/default.nix
{ pkgs, ... }:
{
  imports = [
    # --- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ó–î–ï–°–¨! ---
    # –ü–æ–¥–∫–ª—é—á–∞–µ–º –Ω–∞—à –Ω–æ–≤—ã–π "–ü—É–ª—å—Ç –£–ø—Ä–∞–≤–ª–µ–Ω–∏—è"
    ./options.nix

    ./git.nix
    ./waydroid-idle.nix
  ];

  # –ë–∞–∑–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Home Manager (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
  nixpkgs.config.allowUnfree = true;
  home.stateVersion = "25.11";

  # --- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ó–î–ï–°–¨! ---
  # –£–±–∏—Ä–∞–µ–º –∂–µ—Å—Ç–∫–æ –∑–∞–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –ø–∞–∫–µ—Ç–æ–≤
  # home.packages = [ ... ];

  # –î–µ–∫–ª–∞—Ä–∞—Ç–∏–≤–Ω–æ –≤–∫–ª—é—á–∞–µ–º –Ω–∞–±–æ—Ä—ã –ø–∞–∫–µ—Ç–æ–≤, –æ–±—â–∏–µ –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
  my.home.packages = {
    common = true; # –í–∫–ª—é—á–∞–µ–º –±–∞–∑–æ–≤—ã–π –Ω–∞–±–æ—Ä –¥–ª—è –≤—Å–µ—Ö
  };
}

# ==============================================================================
# –§–ê–ô–õ: ./hosts/shershulya/hardware-configuration.nix
# ==============================================================================

# Do not modify this file!  It was generated by ‚Äònixos-generate-config‚Äô
# and may be overwritten by future invocations.  Please make changes
# to /etc/nixos/configuration.nix instead.
{ config, lib, pkgs, modulesPath, ... }:

{
  imports =
    [ (modulesPath + "/installer/scan/not-detected.nix")
    ];

  boot.initrd.availableKernelModules = [ "xhci_pci" "ahci" "nvme" "usbhid" "usb_storage" "sd_mod" ];
  boot.initrd.kernelModules = [ ];
  boot.kernelModules = [ "kvm-intel" ];
  boot.extraModulePackages = [ ];

  fileSystems."/" =
    { device = "/dev/disk/by-uuid/85de1e10-4038-408b-a4a3-b8da3cd8f18b";
      fsType = "btrfs";
      options = [ "subvol=root" ];
    };

  fileSystems."/home" =
    { device = "/dev/disk/by-uuid/85de1e10-4038-408b-a4a3-b8da3cd8f18b";
      fsType = "btrfs";
      options = [ "subvol=home" ];
    };

  fileSystems."/nix" =
    { device = "/dev/disk/by-uuid/85de1e10-4038-408b-a4a3-b8da3cd8f18b";
      fsType = "btrfs";
      options = [ "subvol=nix" ];
    };

  fileSystems."/var/log" =
    { device = "/dev/disk/by-uuid/85de1e10-4038-408b-a4a3-b8da3cd8f18b";
      fsType = "btrfs";
      options = [ "subvol=log" ];
    };

  fileSystems."/persist" =
    { device = "/dev/disk/by-uuid/85de1e10-4038-408b-a4a3-b8da3cd8f18b";
      fsType = "btrfs";
      options = [ "subvol=persist" ];
    };

  fileSystems."/snapshots" =
    { device = "/dev/disk/by-uuid/85de1e10-4038-408b-a4a3-b8da3cd8f18b";
      fsType = "btrfs";
      options = [ "subvol=snapshots" ];
    };

  fileSystems."/var/cache" =
    { device = "/dev/disk/by-uuid/85de1e10-4038-408b-a4a3-b8da3cd8f18b";
      fsType = "btrfs";
      options = [ "subvol=cache" ];
    };

  fileSystems."/tmp" =
    { device = "/dev/disk/by-uuid/85de1e10-4038-408b-a4a3-b8da3cd8f18b";
      fsType = "btrfs";
      options = [ "subvol=tmp" ];
    };

  fileSystems."/games" =
    { device = "/dev/disk/by-uuid/85de1e10-4038-408b-a4a3-b8da3cd8f18b";
      fsType = "btrfs";
      options = [ "subvol=games" ];
    };

  fileSystems."/boot" =
    { device = "/dev/disk/by-uuid/9B9A-4548";
      fsType = "vfat";
      options = [ "fmask=0022" "dmask=0022" ];
    };

  swapDevices = [ ];

  # Enables DHCP on each ethernet and wireless interface. In case of scripted networking
  # (the default) this is the recommended approach. When using systemd-networkd it's
  # still possible to use this option, but it's recommended to use it in conjunction
  # with explicit per-interface declarations with `networking.interfaces.<interface>.useDHCP`.
  networking.useDHCP = lib.mkDefault true;
  # networking.interfaces.enp0s31f6.useDHCP = lib.mkDefault true;

  nixpkgs.hostPlatform = lib.mkDefault "x86_64-linux";
  hardware.cpu.intel.updateMicrocode = lib.mkDefault config.hardware.enableRedistributableFirmware;
}

# ==============================================================================
# –§–ê–ô–õ: ./hosts/shershulya/default.nix
# ==============================================================================

# hosts/shershulya/default.nix
#
# –≠—Ç–æ—Ç —Ñ–∞–π–ª –æ—Ç–≤–µ—á–∞–µ—Ç –¢–û–õ–¨–ö–û –∑–∞ —Ç–æ, —á—Ç–æ —É–Ω–∏–∫–∞–ª—å–Ω–æ –¥–ª—è –º–∞—à–∏–Ω—ã 'shershulya'.
{ config, pkgs, inputs, lib, ... }:

{
  imports = [
    # –û–±—â–∞—è "–ö–æ–Ω—Å—Ç–∏—Ç—É—Ü–∏—è" –¥–ª—è –≤—Å–µ—Ö –º–∞—à–∏–Ω
    ../_common/default.nix

    # --- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ó–î–ï–°–¨! ---
    # –Ø–≤–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –ø—Ä–æ—Ñ–∏–ª—å –¥–µ—Å–∫—Ç–æ–ø–∞, —Ç–∞–∫ –∫–∞–∫ —ç—Ç–∞ –º–∞—à–∏–Ω–∞ - –¥–µ—Å–∫—Ç–æ–ø.
    ../../modules/roles/desktop.nix

    # –£–Ω–∏–∫–∞–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∂–µ–ª–µ–∑–∞ –¥–ª—è —ç—Ç–æ–≥–æ —Ö–æ—Å—Ç–∞
    ./hardware-configuration.nix
    ../../modules/hardware/nvidia-pascal.nix
    ../../modules/hardware/intel-cpu.nix
  ];

  # --- –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è —Ö–æ—Å—Ç–∞ 'shershulya' ---

  networking.hostName = "shershulya";
  system.stateVersion = "25.11";

  # –î–µ–∫–ª–∞—Ä–∞—Ç–∏–≤–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —á–µ—Ä–µ–∑ –Ω–∞—à –∫–∞—Å—Ç–æ–º–Ω—ã–π API
  my.users.accounts = {
    alex = {
      isMainUser = true;
      description = "Alex";
      extraGroups = [ "adbusers" ];
    };
    mari = {
      description = "Mari";
    };
  };
}

# ==============================================================================
# –§–ê–ô–õ: ./hosts/_common/default.nix
# ==============================================================================

# hosts/_common/default.nix
#
# "–ö–æ–Ω—Å—Ç–∏—Ç—É—Ü–∏—è" –¥–ª—è –≤—Å–µ—Ö –º–æ–∏—Ö —Å–∏—Å—Ç–µ–º.
{ pkgs, ... }:

{
  imports = [
    # –ü–æ–¥–∫–ª—é—á–∞–µ–º –Ω–∞—à "–ø—É–ª—å—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è"
    ../../modules/core/options.nix
    # –ü–æ–¥–∫–ª—é—á–∞–µ–º –Ω–∞—à API –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    ../../modules/core/users.nix

    # –≠—Ç–∞ —Å—Ç—Ä–æ–∫–∞ –ø–µ—Ä–µ–µ–∑–∂–∞–µ—Ç –≤ —Ñ–∞–π–ª –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ö–æ—Å—Ç–∞,
    # —Ç–∞–∫ –∫–∞–∫ –Ω–µ –≤—Å–µ –º–∞—à–∏–Ω—ã –±—É–¥—É—Ç –¥–µ—Å–∫—Ç–æ–ø–∞–º–∏.
    # ../../modules/profiles/desktop.nix
  ];

  # --- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–æ–ª–∏—Ç–∏–∫–∏ –∏ —Å–µ—Ä–≤–∏—Å—ã ---
  # –î–µ–∫–ª–∞—Ä–∞—Ç–∏–≤–Ω–æ –≤–∫–ª—é—á–∞–µ–º –≤—Å–µ, —á—Ç–æ –Ω–∞–º –Ω—É–∂–Ω–æ, —á–µ—Ä–µ–∑ –Ω–∞—à —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π API
  my = {
    # –í–∫–ª—é—á–∞–µ–º –Ω–∞—à–∏ –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–æ–ª–∏—Ç–∏–∫–∏
    policies = {
      allowUnfree = true;
      enableAutoGc = true;
      enableFlakes = true;
    };

    # –í–∫–ª—é—á–∞–µ–º –Ω–∞—à "–ë–∞–∑–æ–≤—ã–π –ü–∞–∫–µ—Ç –ö–æ–º–º—É–Ω–∞–ª—å–Ω—ã—Ö –£—Å–ª—É–≥"
    services.enableCore = true;
  };
}

# ==============================================================================
# –§–ê–ô–õ: ./modules/hardware/nvidia-pascal.nix
# ==============================================================================

# /home/alex/nixos-config/modules/nvidia.nix
{ config, pkgs, lib, ... }:

{
  # –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —è–¥—Ä–∞ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã NVIDIA –Ω–∞ Wayland
  boot.kernelParams = [ "nvidia-drm.modeset=1" "nvidia_drm.fbdev=1" "nvidia.NVreg_EnableGpuFirmware=0" ];

  # –ù–æ–≤—ã–µ –æ–ø—Ü–∏–∏ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∏ (–∑–∞–º–µ–Ω–∞ hardware.opengl)
  hardware.graphics = {
    enable = true;
    enable32Bit = true;
    extraPackages = with pkgs; [
      # –ü–∞–∫–µ—Ç—ã –¥–ª—è –∞–ø–ø–∞—Ä–∞—Ç–Ω–æ–≥–æ —É—Å–∫–æ—Ä–µ–Ω–∏—è –≤–∏–¥–µ–æ
      nvidia-vaapi-driver
      libvdpau-va-gl
    ];
  };

  hardware.nvidia = {
    modesetting.enable = true;
    powerManagement.enable = true;
    powerManagement.finegrained = false;
    open = false;
    nvidiaSettings = true;
    package = config.boot.kernelPackages.nvidiaPackages.beta;
    forceFullCompositionPipeline = true;
  };

  services.xserver.videoDrivers = [ "nvidia" ];

  # –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è Wayland
  environment.sessionVariables = {
    LIBVA_DRIVER_NAME = "nvidia";
    XDG_SESSION_TYPE = "wayland";
    GBM_BACKEND = "nvidia-drm";
    __GLX_VENDOR_LIBRARY_NAME = "nvidia";
    WLR_NO_HARDWARE_CURSORS = "1";
    NIXOS_OZONE_WL = "1";
  };

  # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å–∏—Å—Ç–µ–º–Ω—ã–µ –ø–∞–∫–µ—Ç—ã (—Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–º–∏ –∏–º–µ–Ω–∞–º–∏)
  environment.systemPackages = with pkgs; [
  ];
}

# ==============================================================================
# –§–ê–ô–õ: ./modules/hardware/intel-cpu.nix
# ==============================================================================

# modules/hardware/intel-cpu.nix
#
# –≠—Ç–æ—Ç –º–æ–¥—É–ª—å –ø—Ä–∏–º–µ–Ω—è–µ—Ç –æ–±—â–∏–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –¥–ª—è –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–æ–≤ Intel
# –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è nixos-hardware.
{ inputs, ... }:
{
  imports = [
    # –£–∫–∞–∑—ã–≤–∞–µ–º –ø—É—Ç—å –∫ –º–æ–¥—É–ª—é –≤–Ω—É—Ç—Ä–∏ –Ω–∞—à–µ–≥–æ –Ω–æ–≤–æ–≥–æ 'inputs.hardware'
    inputs.hardware.nixosModules.common-cpu-intel
  ];
}

# ==============================================================================
# –§–ê–ô–õ: ./modules/features/android.nix
# ==============================================================================

# modules/features/android.nix
{ pkgs, lib, ... }: # <-- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ 'lib' –∑–¥–µ—Å—å –µ—Å—Ç—å

{
  virtualisation.waydroid.enable = true;

  # --- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ó–î–ï–°–¨! ---
  # –ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º lib.mkForce, —á—Ç–æ–±—ã –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ù–ê–®–ï –∑–Ω–∞—á–µ–Ω–∏–µ BusName,
  # –∏–≥–Ω–æ—Ä–∏—Ä—É—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ –º–æ–¥—É–ª—è waydroid.nix.
  # –≠—Ç–æ —Ä–µ—à–∞–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–π.
  systemd.services.waydroid-container.serviceConfig.BusName = lib.mkForce "org.waydroid.container";

  # –í–∞—à–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –æ–±—â–µ–π –ø–∞–ø–∫–∏ –∏ —É—Ç–∏–ª–∏—Ç –æ—Å—Ç–∞—é—Ç—Å—è
  fileSystems."/var/lib/waydroid/data/media/0/Shared" = {
    device = "/home/shared/waydroid";
    fsType = "none";
    options = [ "bind" ];
  };

  environment.systemPackages = with pkgs; [
    wl-clipboard
    xorg.xwininfo
    xorg.xprop
  ];
}

# ==============================================================================
# –§–ê–ô–õ: ./modules/features/gaming.nix
# ==============================================================================

# modules/features/gaming.nix
{ pkgs, ... }:
{
  environment.sessionVariables = { MANGOHUD = "1"; };
  programs.steam = {
    enable = true;
    extraCompatPackages = [ pkgs.proton-ge-bin ];
  };
  programs.gamemode.enable = true;
  environment.systemPackages = with pkgs; [ gamescope ];
}

# ==============================================================================
# –§–ê–ô–õ: ./modules/features/desktop.nix
# ==============================================================================

# modules/features/desktop.nix
#
# –≠—Ç–æ—Ç –º–æ–¥—É–ª—å —Ä–µ–∞–ª–∏–∑—É–µ—Ç –≤—Å–µ, —á—Ç–æ –Ω—É–∂–Ω–æ –¥–ª—è –±–∞–∑–æ–≤–æ–≥–æ –¥–µ—Å–∫—Ç–æ–ø–∞.
{ pkgs, ... }:
{
  networking.networkmanager.enable = true;
  # –í–∫–ª—é—á–∞–µ–º —Å–∏—Å—Ç–µ–º–Ω—É—é —Å–ª—É–∂–±—É DNS, –Ω–µ–æ–±—Ö–æ–¥–∏–º—É—é –¥–ª—è NetworkManager
  services.resolved.enable = true;

  services.xserver.enable = true;
  services.xserver.xkb = { layout = "us,ru"; options = "grp:alt_shift_toggle"; };
  services.displayManager.sddm.enable = true;
  services.desktopManager.plasma6.enable = true;
  services.pipewire = {
    enable = true;
    alsa.enable = true;
    alsa.support32Bit = true;
    pulse.enable = true;
  };
}

# ==============================================================================
# –§–ê–ô–õ: ./modules/features/dpi-tunnel.nix
# ==============================================================================

# modules/features/dpi-tunnel.nix
{ pkgs, ... }:
{
  # –°–æ–∑–¥–∞–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–π —Å–µ—Ä–≤–∏—Å, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –Ω–∞—à "–ª–∞–∑–µ—Ä–Ω—ã–π —Ä–µ–∑–∞–∫".
  systemd.services.dpitunnel = {
    description = "DPI Tunnel Proxy Service";
    # –ó–∞–ø—É—Å–∫–∞–µ–º –ø–æ—Å–ª–µ —Ç–æ–≥–æ, –∫–∞–∫ —Å–µ—Ç—å –±—É–¥–µ—Ç –≥–æ—Ç–æ–≤–∞.
    after = [ "network-online.target" ];
    wants = [ "network-online.target" ];
    # –í–∫–ª—é—á–∞–µ–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–∏—Å—Ç–µ–º—ã.
    wantedBy = [ "multi-user.target" ];

    serviceConfig = {
      # --- –ì–õ–ê–í–ù–ê–Ø –ú–ê–ì–ò–Ø! ---
      # –ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–≤—É—é –∏–∑ –¥–≤—É—Ö "–º–∞–≥–∏—á–µ—Å–∫–∏—Ö —Å—Ç—Ä–æ–∫", —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω—ã—Ö –∞–≤—Ç–æ—Ä–æ–º.
      # –ú—ã —Ç–∞–∫–∂–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ —É–∫–∞–∑—ã–≤–∞–µ–º –ø—É—Ç—å –∫ –∫–æ—Ä–Ω–µ–≤—ã–º —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞–º.
      ExecStart = ''
        ${pkgs.dpitunnel}/bin/dpitunnel \
          --ca-bundle-path=${pkgs.cacert}/etc/ssl/certs/ca-bundle.crt \
          --desync-attacks=fake,disorder_fake \
          --split-position=2 \
          --auto-ttl=1-4-10 \
          --min-ttl=3 \
          --doh \
          --doh-server=https://dns.google/dns-query \
          --wsize=1 \
          --wsfactor=6
      '';

      # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—Ç—å, –µ—Å–ª–∏ –æ–Ω —É–ø–∞–¥–µ—Ç.
      Restart = "always";
      RestartSec = "10s";
    };
  };
}

# ==============================================================================
# –§–ê–ô–õ: ./modules/features/smart-dns.nix
# ==============================================================================

# modules/features/smart-dns.nix
#
# –§–∏–Ω–∞–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è dnscrypt-proxy2, –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è
# –¥–ª—è —Ä–∞–±–æ—Ç—ã –≤ —É—Å–ª–æ–≤–∏—è—Ö –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π.
{ config, pkgs, lib, ... }:

{
  # –ü–æ–ª–Ω–æ—Å—Ç—å—é –æ—Ç–∫–ª—é—á–∞–µ–º —Å—Ç–∞—Ä—ã–π —Å–µ—Ä–≤–∏—Å, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤.
  services.resolved.enable = lib.mkForce false;

  # –í–∫–ª—é—á–∞–µ–º –Ω–∞—à –Ω–æ–≤—ã–π, —É–º–Ω—ã–π DNS-–ø—Ä–æ–∫—Å–∏.
  services.dnscrypt-proxy2 = {
    enable = true;
    settings = {
      listen_addresses = [ "127.0.0.1:53" ];

      # –£–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω—ã—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤.
      server_names = [
        "yandex-dns"
        "adguard-dns"
        "scaleway-fr"
        "quad9-dnscrypt-ip4-filter-pri"
      ];

      # --- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ó–î–ï–°–¨! ---
      # –ú—ã –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞–µ–º [anonymized_dns] –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å —è–∑—ã–∫–∞ Nix:
      # –∏–º—è_–∞—Ç—Ä–∏–±—É—Ç–∞ = { ... };
      anonymized_dns = {
        routes = [
          { server_name="scaleway-fr"; via=["yandex-dns"]; }
        ];
      };

      # –†–µ–∑–µ—Ä–≤–Ω—ã–π DNS, –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ–π–¥–µ—Ç –Ω–µ —Ç–∞–∫ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ
      fallback_resolver = "1.1.1.1:53";

      # –í–∫–ª—é—á–∞–µ–º –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
      cache = true;
      cache_size = 512;
    };
  };

  # –ó–∞—Å—Ç–∞–≤–ª—è–µ–º —Å–µ—Ä–≤–∏—Å –∂–¥–∞—Ç—å, –ø–æ–∫–∞ —Å–µ—Ç—å –±—É–¥–µ—Ç –≥–æ—Ç–æ–≤–∞.
  systemd.services.dnscrypt-proxy2.after = [ "network-online.target" ];
  systemd.services.dnscrypt-proxy2.wants = [ "network-online.target" ];

  # –£–∫–∞–∑—ã–≤–∞–µ–º —Å–∏—Å—Ç–µ–º–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ù–ê–® –ª–æ–∫–∞–ª—å–Ω—ã–π DNS-–ø—Ä–æ–∫—Å–∏.
  networking.nameservers = [ "127.0.0.1" ];

  # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ—Ç–∫–ª—é—á–∞–µ–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ DNS —á–µ—Ä–µ–∑ NetworkManager.
  networking.networkmanager.dns = lib.mkForce "none";

  # –ü—Ä–∞–≤–∏–ª–∞ —Ñ–∞–π—Ä–≤–æ–ª–∞ –æ—Å—Ç–∞—é—Ç—Å—è, –æ–Ω–∏ –≤–∞–∂–Ω—ã.
  networking.firewall = {
    enable = true;
    allowedUDPPorts = [ 53 ];
    allowedTCPPorts = [ 53 ];
  };
}

# ==============================================================================
# –§–ê–ô–õ: ./modules/features/vpn.nix
# ==============================================================================

# modules/features/vpn.nix
#
# –§–∏–Ω–∞–ª—å–Ω–∞—è, —Ä–∞–±–æ—á–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è AmneziaWG,
# –æ—Å–Ω–æ–≤–∞–Ω–Ω–∞—è –Ω–∞ –≤–∞—à–µ–º –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω–æ–º —à–∞–±–ª–æ–Ω–µ –∏ –Ω–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö.
{ config, pkgs, ... }:

{
  # 1. –ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥—É–ª—è —è–¥—Ä–∞ –¥–ª—è Zen (—ç—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∏ –æ—Å—Ç–∞–µ—Ç—Å—è)
  boot.extraModulePackages = [ pkgs.linuxKernel.packages.linux_zen.amneziawg ];

  # 2. –£—Ç–∏–ª–∏—Ç—ã (–æ—Å—Ç–∞—é—Ç—Å—è)
  environment.systemPackages = with pkgs; [
    amnezia-vpn
    amneziawg-tools
    amneziawg-go
  ];

  # 3. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ñ–∞–π–ª (–ö–ª—é—á–µ–≤–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ!)
  # –ú—ã —Å–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ñ–∞–π–ª, –∏—Å–ø–æ–ª—å–∑—É—è –¥–∞–Ω–Ω—ã–µ –∏–∑ –≤–∞—à–µ–≥–æ –Ω–æ–≤–æ–≥–æ WARP-1.conf.
  environment.etc."amnezia/amneziawg/awg0.conf" = {
    text = ''
      [Interface]
      PrivateKey = 4LSnIheBiDOwqM/KAmrYa1vyDUSVfo41bRLHlaAM8G8=
      S1 = 0
      S2 = 0
      Jc = 120
      Jmin = 23
      Jmax = 911
      H1 = 1
      H2 = 2
      H3 = 3
      H4 = 4
      MTU = 1280
      Address = 172.16.0.2, 2606:4700:110:81f5:76e4:76c5:2820:772d
      DNS = 1.1.1.1, 2606:4700:4700::1111, 1.0.0.1, 2606:4700:4700::1001

      [Peer]
      PublicKey = bmXOC+F1FxEMF9dyiK2H5/1SUtzH0JuVo51h2wPfgyo=
      AllowedIPs = 0.0.0.0/0, ::/0
      Endpoint = 188.114.99.224:1002
    '';
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∞ "—Ç–æ–ª—å–∫–æ –¥–ª—è —á—Ç–µ–Ω–∏—è" –¥–ª—è root
    mode = "0400";
  };

  # 4. –ù–∞–¥–µ–∂–Ω—ã–π —Å–µ—Ä–≤–∏—Å systemd (–æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
  # –ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–π —Å–ø–æ—Å–æ–± –∑–∞–ø—É—Å–∫–∞ —á–µ—Ä–µ–∑ awg-quick.
  systemd.services.amnezia-vpn = {
    description = "AmneziaWG auto-connect service";
    after = [ "network-online.target" ];
    wants = [ "network-online.target" ];
    wantedBy = [ "multi-user.target" ];
    serviceConfig = {
      Type = "oneshot";
      RemainAfterExit = true;
      ExecStart = "${pkgs.amneziawg-tools}/bin/awg-quick up awg0";
      ExecStop = "${pkgs.amneziawg-tools}/bin/awg-quick down awg0";
    };
  };
}

# ==============================================================================
# –§–ê–ô–õ: ./modules/core/options.nix
# ==============================================================================

# modules/options.nix
#
# –ù–∞—à —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π "–ü—É–ª—å—Ç –£–ø—Ä–∞–≤–ª–µ–Ω–∏—è".
# –ó–¥–µ—Å—å –º—ã –æ–±—ä—è–≤–ª—è–µ–º –≤—Å–µ –∫–∞—Å—Ç–æ–º–Ω—ã–µ –æ–ø—Ü–∏–∏ –∏ —Å–≤—è–∑—ã–≤–∞–µ–º –∏—Ö —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ NixOS.
{ lib, config, pkgs, ... }:

{
  # =================================================================
  # –†–ê–ó–î–ï–õ 1: "–ü–ê–ù–ï–õ–¨ –£–ü–†–ê–í–õ–ï–ù–ò–Ø" (options.my)
  # –ó–¥–µ—Å—å –º—ã –æ–±—ä—è–≤–ª—è–µ–º –Ω–∞—à–∏ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ, –∫—Ä–∞—Å–∏–≤—ã–µ "–ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–∏".
  # –≠—Ç–æ –Ω–∞—à –≤—ã—Å–æ–∫–æ—É—Ä–æ–≤–Ω–µ–≤—ã–π API –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º–æ–π.
  # =================================================================
  options.my = {
    locale.enableRussian = lib.mkEnableOption "–ü–æ–ª–Ω–∞—è —Ä—É—Å–∏—Ñ–∏–∫–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã";

    optimizations = {
      enableSsdTweaks = lib.mkEnableOption "–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –¥–ª—è SSD (fstrim)";
      enableZlibNg = lib.mkEnableOption "–í—ã—Å–æ–∫–æ–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ zlib-ng";
      enableDesktopResponsiveness = lib.mkEnableOption "–°–ª—É–∂–±—ã –¥–ª—è –æ—Ç–∑—ã–≤—á–∏–≤–æ—Å—Ç–∏ –¥–µ—Å–∫—Ç–æ–ø–∞";
    };

    policies = {
      allowUnfree = lib.mkEnableOption "–†–∞–∑—Ä–µ—à–∏—Ç—å –Ω–µ—Å–≤–æ–±–æ–¥–Ω—ã–µ –ø–∞–∫–µ—Ç—ã";
      enableAutoGc = lib.mkEnableOption "–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–±–æ—Ä–∫–∞ –º—É—Å–æ—Ä–∞";
      enableFlakes = lib.mkEnableOption "–í–∫–ª—é—á–∏—Ç—å Flakes –∏ nix-command";
    };

    # –ù–∞—à "–ë–∞–∑–æ–≤—ã–π –ü–∞–∫–µ—Ç –ö–æ–º–º—É–Ω–∞–ª—å–Ω—ã—Ö –£—Å–ª—É–≥"
    services.enableCore = lib.mkEnableOption "–í–∫–ª—é—á–∏—Ç—å –±–∞–∑–æ–≤—ã–π –Ω–∞–±–æ—Ä —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ –∏ —É—Ç–∏–ª–∏—Ç";
  };

  # =================================================================
  # –†–ê–ó–î–ï–õ 2: "–ú–ê–®–ò–ù–ù–û–ï –û–¢–î–ï–õ–ï–ù–ò–ï" (config)
  # –ó–¥–µ—Å—å –º—ã —Å–≤—è–∑—ã–≤–∞–µ–º –Ω–∞—à–∏ –∫—Ä–∞—Å–∏–≤—ã–µ "–ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–∏"
  # —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏, –Ω–∏–∑–∫–æ—É—Ä–æ–≤–Ω–µ–≤—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ NixOS.
  # =================================================================
  config = lib.mkMerge [
    # --- –ë–ª–æ–∫ 1: –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ ---
    {
      time.timeZone = lib.mkIf config.my.locale.enableRussian "Europe/Moscow";
      i18n.defaultLocale = lib.mkIf config.my.locale.enableRussian "ru_RU.UTF-8";
      console.keyMap = lib.mkIf config.my.locale.enableRussian "ru";

      services.fstrim.enable = lib.mkIf config.my.optimizations.enableSsdTweaks true;
      nixpkgs.config.zlib.package = lib.mkIf config.my.optimizations.enableZlibNg pkgs.zlib-ng;

      security.rtkit.enable = lib.mkIf config.my.optimizations.enableDesktopResponsiveness true;
      services.irqbalance.enable = lib.mkIf config.my.optimizations.enableDesktopResponsiveness true;
      services.ananicy.enable = lib.mkIf config.my.optimizations.enableDesktopResponsiveness true;

      nixpkgs.config.allowUnfree = lib.mkIf config.my.policies.allowUnfree true;
      nix.gc = lib.mkIf config.my.policies.enableAutoGc {
        automatic = true;
        dates = "weekly";
        options = "--delete-older-than 7d";
      };
      nix.optimise.automatic = lib.mkIf config.my.policies.enableAutoGc true;
      nix.settings.experimental-features = lib.mkIf config.my.policies.enableFlakes [ "nix-command" "flakes" ];
    }

    # --- –ë–ª–æ–∫ 2: –ù–∞—à "–ë–∞–∑–æ–≤—ã–π –ü–∞–∫–µ—Ç –ö–æ–º–º—É–Ω–∞–ª—å–Ω—ã—Ö –£—Å–ª—É–≥" ---
    (lib.mkIf config.my.services.enableCore {
      services.timesyncd.enable = true;
      networking.firewall.enable = true;
      environment.systemPackages = [
        pkgs.git
        pkgs.nix-index
      ];
      programs.nix-index.enable = true;
      programs.command-not-found.enable = false;
    })
  ];
}

# ==============================================================================
# –§–ê–ô–õ: ./modules/core/users.nix
# ==============================================================================

# modules/users.nix
#
# –ù–∞—à —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π, –≤—ã—Å–æ–∫–æ—É—Ä–æ–≤–Ω–µ–≤—ã–π –º–æ–¥—É–ª—å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏.
{ lib, config, self, inputs, mylib, ... }: # <-- –î–æ–±–∞–≤–ª—è–µ–º 'mylib' –≤ –∞—Ä–≥—É–º–µ–Ω—Ç—ã

let
  cfg = config.my.users;
in
{
  # --- –û–±—ä—è–≤–ª—è–µ–º –Ω–∞—à API –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π ---
  options.my.users.accounts = lib.mkOption {
    type = with lib.types; attrsOf (submodule {
      options = {
        isMainUser = lib.mkEnableOption "–≠—Ç–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —è–≤–ª—è–µ—Ç—Å—è –æ—Å–Ω–æ–≤–Ω—ã–º (–¥–ª—è –∞–≤—Ç–æ–ª–æ–≥–∏–Ω–∞)";
        description = lib.mkOption {
          type = str;
          default = "";
          description = "–ü–æ–ª–Ω–æ–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.";
        };
        extraGroups = lib.mkOption {
          type = listOf str;
          default = [];
          description = "–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≥—Ä—É–ø–ø—ã –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.";
        };
      };
    });
    default = {};
    description = "–î–µ–∫–ª–∞—Ä–∞—Ç–∏–≤–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ —Å–∏—Å—Ç–µ–º–µ.";
  };

  # --- –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–∞—à–µ–≥–æ API ---
  config = {
    # 1. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –±–ª–æ–∫ users.users
    users.users = lib.mapAttrs
      (name: userCfg: {
        isNormalUser = true;
        description = userCfg.description;
        extraGroups = [ "wheel" "networkmanager" "video" ] ++ userCfg.extraGroups;
      })
      cfg.accounts;

    # 2. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –±–ª–æ–∫ home-manager.users
    home-manager.users = lib.mapAttrs
      (name: _:
        # –ú—ã —Å—Ç—Ä–æ–∏–º "—á–∏—Å—Ç—ã–π" –ø—É—Ç—å –æ—Ç –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É—è 'self'.
        import "${self}/home/${name}"
      )
      cfg.accounts;

    # --- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ó–î–ï–°–¨! ---
    # 3. –ü–µ—Ä–µ–¥–∞–µ–º –í–°–ï –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã –≤ –º–æ–¥—É–ª–∏ Home Manager.
    # –†–∞–Ω—å—à–µ –∑–¥–µ—Å—å –Ω–µ –±—ã–ª–æ 'mylib' –∏ 'self'.
    home-manager.extraSpecialArgs = { inherit inputs self mylib; };

    # 4. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –±–ª–æ–∫ –∞–≤—Ç–æ–ª–æ–≥–∏–Ω–∞ –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    services.displayManager.autoLogin =
      let
        mainUsers = lib.filterAttrs (name: userCfg: userCfg.isMainUser) cfg.accounts;
        mainUserName = lib.head (lib.attrNames mainUsers);
      in
      lib.mkIf (mainUsers != {}) {
        enable = true;
        user = mainUserName;
      };
  };
}

# ==============================================================================
# –§–ê–ô–õ: ./modules/roles/desktop.nix
# ==============================================================================

# modules/profiles/desktop.nix
#
# –≠—Ç–æ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å ("–Ω–∞–±–æ—Ä LEGO") –¥–ª—è –ª—é–±–æ–≥–æ –≤–∞—à–µ–≥–æ "–æ—Å–Ω–æ–≤–Ω–æ–≥–æ –¥–µ—Å–∫—Ç–æ–ø–∞".
# --- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ó–î–ï–°–¨! ---
# –ú—ã –ø—Ä–µ–≤—Ä–∞—â–∞–µ–º —ç—Ç–æ—Ç —Ñ–∞–π–ª –≤ —Ñ—É–Ω–∫—Ü–∏—é, –∫–æ—Ç–æ—Ä–∞—è –ø—Ä–∏–Ω–∏–º–∞–µ—Ç 'pkgs' –≤ –∫–∞—á–µ—Å—Ç–≤–µ –∞—Ä–≥—É–º–µ–Ω—Ç–∞.
{ pkgs, ... }:

{
  imports = [
    # –ü–æ–¥–∫–ª—é—á–∞–µ–º "–∫–∏—Ä–ø–∏—á–∏–∫–∏"-—Ñ–∏—á–∏
    ../features/desktop.nix
    ../features/gaming.nix
    #../features/android.nix
  ];

  # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç –∑–∞–≥—Ä—É–∑–∫–∏ –¥–ª—è –≤—Å–µ—Ö –Ω–∞—à–∏—Ö –¥–µ—Å–∫—Ç–æ–ø–æ–≤
  boot = {
    loader.systemd-boot.enable = true;
    loader.efi.canTouchEfiVariables = true;
    loader.timeout = 0;

    # –¢–µ–ø–µ—Ä—å 'pkgs' –∑–¥–µ—Å—å –∏–∑–≤–µ—Å—Ç–µ–Ω, –∏ —ç—Ç–∞ —Å—Ç—Ä–æ–∫–∞ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
    kernelPackages = pkgs.linuxPackages_zen;
  };

  # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è —ç—Ç–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è
  my = {
    locale.enableRussian = true;
    optimizations = {
      enableSsdTweaks = true;
      enableZlibNg = true;
      enableDesktopResponsiveness = true;
    };
  };
}

# ==============================================================================
# –§–ê–ô–õ: ./lib/default.nix
# ==============================================================================

# lib/default.nix
# –ù–∞—à–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π.
{ lib, pkgs, ... }:

{
  myHelpers = {
    # --- –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç ‚Ññ1: –ü–æ–ª—É—á–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ Git (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
    getGitConfigForUser = userName:
      let
        userMap = {
          alex = { userName = "Alex"; userEmail = "skardizone@gmail.com"; };
        };
        defaultUser = { userName = "NixOS User"; userEmail = "user@localhost"; };
      in
      userMap.${userName} or defaultUser;

    # --- –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç ‚Ññ2: –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Å–∫—Ä–∏–ø—Ç–∞ Waydroid (–£–ª—É—á—à–µ–Ω–Ω—ã–π) ---
    makeWaydroidIdleScript = { pkgs }:
      pkgs.writeShellScriptBin "waydroid-idle-manager" ''
        #!${pkgs.bash}/bin/bash
        TIMEOUT_SECONDS=300
        last_seen_timestamp=0

        # –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏, –æ—Ç–∫—Ä—ã—Ç—ã –ª–∏ –æ–∫–Ω–∞ Waydroid
        are_waydroid_windows_open() {
          local window_ids=$(${pkgs.xorg.xwininfo}/bin/xwininfo -root -children | grep "^\s\+0x" | awk '{print $1}')
          for id in $window_ids; do
            if ${pkgs.xorg.xprop}/bin/xprop -id "$id" WM_CLASS | grep -q "waydroid"; then
              return 0 # 0 –æ–∑–Ω–∞—á–∞–µ—Ç "–¥–∞, –æ—Ç–∫—Ä—ã—Ç—ã"
            fi
          done
          return 1 # 1 –æ–∑–Ω–∞—á–∞–µ—Ç "–Ω–µ—Ç, –Ω–µ –æ—Ç–∫—Ä—ã—Ç—ã"
        }

        echo "WayDroid Idle Manager –∑–∞–ø—É—â–µ–Ω –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è $USER."
        while true; do
          if are_waydroid_windows_open; then
            last_seen_timestamp=$(date +%s)
          else
            if [[ $last_seen_timestamp -ne 0 ]]; then
              current_time=$(date +%s)
              elapsed=$((current_time - last_seen_timestamp))
              if [[ $elapsed -gt $TIMEOUT_SECONDS ]]; then
                echo "–¢–∞–π–º–∞—É—Ç ($TIMEOUT_SECONDS —Å–µ–∫) –¥–æ—Å—Ç–∏–≥–Ω—É—Ç. –û—Å—Ç–∞–Ω–æ–≤–∫–∞ WayDroid..."
                ${pkgs.waydroid}/bin/waydroid session stop
                # --- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ó–î–ï–°–¨! ---
                # –í–º–µ—Å—Ç–æ 'sudo systemctl stop ...' –º—ã –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ D-Bus.
                ${pkgs.glib}/bin/gdbus call --system --dest org.waydroid.container \
                  --object-path /org/freedesktop/systemd1 \
                  --method org.freedesktop.systemd1.Manager.StopUnit "waydroid-container.service" "replace"
                echo "WayDroid –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω."
                last_seen_timestamp=0
              fi
            fi
          fi
          sleep 10
        done
      '';
  };
}

# ==============================================================================
# –§–ê–ô–õ: ./flake.nix
# ==============================================================================

# flake.nix
{
  description = "–ú–æ—è –¥–µ–∫–ª–∞—Ä–∞—Ç–∏–≤–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è NixOS";

  inputs = {
    nixpkgs.url = "github:NixOS/nixpkgs/nixos-unstable";
    hardware.url = "github:NixOS/nixos-hardware/master";
    home-manager = {
      url = "github:nix-community/home-manager";
      inputs.nixpkgs.follows = "nixpkgs";
    };
    # --- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ó–î–ï–°–¨! ---
    # –ú—ã –ø–æ–ª–Ω–æ—Å—Ç—å—é —É–¥–∞–ª—è–µ–º –±–ª–æ–∫ plasma-manager.
    # plasma-manager = {
    #   url = "github:nix-community/plasma-manager";
    #   inputs.nixpkgs.follows = "nixpkgs";
    # };
  };

  outputs = { self, nixpkgs, home-manager, ... }@inputs:
    let
      mylib = import ./lib { lib = nixpkgs.lib; pkgs = nixpkgs.legacyPackages."x86_64-linux"; };
    in
    {
      nixosConfigurations = {
        shershulya = nixpkgs.lib.nixosSystem {
          system = "x86_64-linux";
          specialArgs = { inherit inputs self mylib; };
          modules = [
            # --- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ó–î–ï–°–¨! ---
            # –ú—ã –ø–æ–ª–Ω–æ—Å—Ç—å—é —É–¥–∞–ª—è–µ–º —Å—Ç—Ä–æ–∫—É, –∫–æ—Ç–æ—Ä–∞—è –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–ª–∞ –æ–≤–µ—Ä–ª–µ–∏.
            # { nixpkgs.overlays = [ (import ./overlays) ]; }

            ./hosts/shershulya
            home-manager.nixosModules.home-manager
          ];
        };
      };

      homeConfigurations = {
        "alex@shershulya" = home-manager.lib.homeManagerConfiguration {
          # --- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ó–î–ï–°–¨! ---
          # –ú—ã –±–æ–ª—å—à–µ –Ω–µ —Ä–∞—Å—à–∏—Ä—è–µ–º –ø–∞–∫–µ—Ç—ã –æ–≤–µ—Ä–ª–µ—è–º–∏.
          # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π, —á–∏—Å—Ç—ã–π –Ω–∞–±–æ—Ä –ø–∞–∫–µ—Ç–æ–≤.
          pkgs = nixpkgs.legacyPackages."x86_64-linux";
          extraSpecialArgs = { inherit inputs self mylib; };
          modules = [ ./home/alex ];
        };
        "mari@shershulya" = home-manager.lib.homeManagerConfiguration {
          # –ò –¥–ª—è –≤—Ç–æ—Ä–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Ç–æ–∂–µ.
          pkgs = nixpkgs.legacyPackages."x86_64-linux";
          extraSpecialArgs = { inherit inputs self mylib; };
          modules = [ ./home/mari ];
        };
      };
    };
}
